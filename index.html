<!doctype html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>唯哆apk下载</title>
    <link rel="stylesheet" type="text/css" href="css/home.css"/>
    
</head>

<body>
    <div class="all_center">
        <h1>唯哆内测apk下载</h1>
        
        <div class="top_row">
            <img class="logo_img" src="assets/logo.png" alt="App Logo"/>
            <div class="top_column">
                <h4>应用名：唯哆</h4>
				<div style="display: inline-block; text-align: left;">

          <h5>版本信息: V2.7.3_20240425 18:18:54</h5>
					<h5 id="iosInfo">iOS版本信息: V2.7.3_20240424 19:11:32</h5>

					<h5 id="vfplayerDemo">播放器demo更新信息: 20231108 10_43_45</h5>
				</div>  
            </div>
        </div>
        <div class="top_row" id="buttons" style="display: none;">
            <a href="https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240425/18_18_54.apk" id="download"></a>
            <button class="button_download" id="releaseButton" onclick="downloadReleaseApk()">release apk下载</button>
            <button class="button_download" id="debugButton" onclick="downloadDebugApk()">debug apk下载</button>
            <button class="button_download" id="ipaButton" onclick="downloadIpa()">iOS下载</button>
            <button class="button_download" id="vfplayerDemoButton" onclick="downloadVfplayerDemo()">播放器demo下载</button>
        </div>
        <br>
        <div class="bottom_column" id="qrcode" style="display: none;">
                <p>扫描下方二维码直接下载release版的apk文件</p>
                <img class="qrcode_img" src="assets/downloadqrcode.png" id="qrImg" alt="QR Code" class="img-fluid" />

                <h3>历史Apk版本</h3>
                <ul id="history_version"></ul>
        </div>
        <h5 id="history_info" style="display: none;">["https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240425/18_18_54.apk","https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240424/18_59_00.apk","https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240424/18_16_57.apk","https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240424/10_35_01.apk","https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240422/18_18_21.apk","https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240422/15_21_18.apk","https://test.sihuacloud.com:39002/app/V2.7.3/apk/20240419/10_01_30.apk","https://test.sihuacloud.com:39002/app/V2.7.2/apk/20240418/14_38_28.apk","https://test.sihuacloud.com:39002/app/V2.7.2/apk/20240418/10_45_10.apk","https://test.sihuacloud.com:39002/app/V2.7.2/apk/20240417/14_35_41.apk","https://test.sihuacloud.com:39002/app/V2.7.1/apk/20240411/15_16_46.apk","https://test.sihuacloud.com:39002/app/V2.7.0/apk/20240325/14_13_11.apk","https://test.sihuacloud.com:39002/app/V2.6.7/apk/20240306/18_00_44.apk","https://test.sihuacloud.com:39002/app/V2.6.5/apk/20240223/17_52_22.apk","https://test.sihuacloud.com:39002/app/V2.6.0/apk/20240219/11_44_48.apk"]</h5>
        <div style="padding-bottom: 30px"></div>
        
    </div>
    <div class="dialog_center" id="inputDialog" style="display: block;">
        <h2>口令</h2>
        <input type="text" id="codeInput" placeholder="请输入口令">
        <button id="validateBtn">提交</button>
    </div>

    <script>

      var button = document.getElementById('download');
      var originalString = button.href;
      originalString = originalString.replace('.apk', '');
      var words = originalString.split("/");
      // console.log(words);
      if (words.length >= 2) {
        let first = words[words.length - 2];
        let second = words[words.length - 1];
        
        var qrImg = document.getElementById('qrImg');
        qrImg.src = "assets/downloadqrcode" + first + second + ".png";

      }

        function downloadDebugApk() {
            var button = document.getElementById('download');
            let originalString = button.href;
            let replacedString = originalString.replace('.apk', '_debug.apk');
            let downloadLink = document.createElement('a');
            downloadLink.href = replacedString;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

        }
        function downloadReleaseApk() {
            var button = document.getElementById('download');
            let originalString = button.href;
            let downloadLink = document.createElement('a');
            downloadLink.href = originalString;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
        function downloadIpa(){
          var platform = navigator.platform.toLowerCase();
          if (platform.includes("iphone") || platform.includes("ipad") || platform.includes("ipod")) {

            var isWeChat = /micromessenger/i.test(navigator.userAgent);
            var isDingTalk = /dingtalk/i.test(navigator.userAgent);
            if (isWeChat || isDingTalk) {
              openSafari();
            }else{
              downloadiOS();
            }
          }else{
            alert("请使用iOS设备下载哦！");
          }

        }
        function openSafari() {
          if (/iphone|ipod|ipad/i.test(navigator.userAgent)) {
            window.location.href = 'itms-services:///?action=download-manifest&url=https://test.sihuacloud.com:39002/app/wiodo_ipa/manifest.plist';
          } else {
            console.log('This feature is only available on iOS devices.');
          }
        }
        function downloadiOS(){
          let downloadLink = document.createElement('a');
            downloadLink.href = "itms-services:///?action=download-manifest&url=https://test.sihuacloud.com:39002/app/wiodo_ipa/manifest.plist";
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
        function downloadVfplayerDemo(){

          var vfplayerDemo = document.getElementById('vfplayerDemo');
          var text = vfplayerDemo.innerHTML;
          var words = text.split(" ");
          console.log(words);
          var url = "https://test.sihuacloud.com:39002/app/vfplayer_demo/" + words[words.length-2] + "/" + words[words.length-1] + ".apk";
          let downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
        if (!getValue()) {
            var validateBtn = document.getElementById("validateBtn");
            var codeInput = document.getElementById("codeInput");
            validateBtn.addEventListener("click", function() {
                var code = codeInput.value;
                if (code == "wiodo1234") {
                  alert("验证通过！");
                  var buttons = document.getElementById("buttons");
                  buttons.style.display = "block";
                  var qrcode = document.getElementById("qrcode");
                  qrcode.style.display = "block";
                  var inputDialog = document.getElementById("inputDialog");
                  inputDialog.style.display = "none";
                  setValue();
                } else {
                  alert("验证码错误！");
                }
              });
            codeInput.addEventListener("keyup", function(event) {
                if (event.keyCode == 13) {
                    var code = codeInput.value;
                    if (code == "wiodo1234") {
                      alert("验证通过！");
                      var buttons = document.getElementById("buttons");
                      buttons.style.display = "block";
                      var qrcode = document.getElementById("qrcode");
                      qrcode.style.display = "block";
                      var inputDialog = document.getElementById("inputDialog");
                      inputDialog.style.display = "none";
                      setValue();
                    } else {
                      alert("验证码错误！");
                    }
                    
                }
                
              });
        }else{
            var buttons = document.getElementById("buttons");
            buttons.style.display = "block";
            var qrcode = document.getElementById("qrcode");
            qrcode.style.display = "block";
            var inputDialog = document.getElementById("inputDialog");
            inputDialog.style.display = "none";
        }

        function setValue() {
          var expirationTime = new Date().getTime() + (2 * 60 * 1000);
          var data = {
            expiresAt: expirationTime
          };
          localStorage.setItem("validate", JSON.stringify(data));
        }

        function getValue() {
          var data = localStorage.getItem("validate");
          if (data) {
            data = JSON.parse(data);
            if (new Date().getTime() < data.expiresAt) {
              return true;
            } else {
              localStorage.removeItem("validate");
              return false;
            }
          }
          return false;
        }

        function handleClick(param) {
          return function() {
            let downloadLink = document.createElement('a');
            downloadLink.href = param;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
          }
        }

        dealHistoryInfo();
        function dealHistoryInfo(){
          var history_info = document.getElementById("history_info");
          console.log(history_info.textContent);
          var list = JSON.parse(history_info.textContent);
          
          var ul = document.getElementById("history_version");
          for (var i = 1; i < list.length; i++) {
            var version_url = list[i];
            version_url = version_url.replace("https://test.sihuacloud.com:39002/app/","");
            version_url = version_url.replace(".apk","");
            version_url = version_url.replace(/_/g, ":");
            version_url = version_url.replace("/apk/","_");
            version = version_url.replace("/"," ");

            var li = document.createElement("li");
            var btn = document.createElement("button"); 
            btn.class = "button_download"; 
            btn.id = "releaseButton"+i;
            btn.textContent = version;
            btn.addEventListener("click", handleClick(list[i])); 
            li.appendChild(btn);
            var btn1 = document.createElement("a"); 
            btn1.textContent = "···";
            li.appendChild(btn1);
            var btn2 = document.createElement("button"); 
            btn2.class = "button_download"; 
            btn2.id = "debugButton"+i;
            btn2.textContent = "debug";
            var debug_url = list[i];
            debug_url = debug_url.replace(".apk","_debug.apk");
            btn2.addEventListener("click", handleClick(debug_url)); 
            li.appendChild(btn2);
            ul.appendChild(li); 
          }

        }


    </script>
</body>

</html>
